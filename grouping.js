var sourceList = [
  {
    "start": 0,
    "end": 1,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": null
    }
  }, {
    "start": 1,
    "end": 2,
    "string": "(",
    "type": "bracket",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 2,
    "end": 3,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 3,
    "end": 27,
    "string": "streaming_media_protocol",
    "type": "string-2",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 27,
    "end": 28,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 28,
    "end": 29,
    "string": ">",
    "type": "operator",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 29,
    "end": 31,
    "string": "12",
    "type": "number",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 31,
    "end": 32,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 32,
    "end": 35,
    "string": "AND",
    "type": "keyword",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 35,
    "end": 36,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 36,
    "end": 52,
    "string": "common_recv_time",
    "type": "string-2",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 52,
    "end": 53,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 53,
    "end": 54,
    "string": "<",
    "type": "operator",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 54,
    "end": 55,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 55,
    "end": 57,
    "string": "23",
    "type": "number",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 57,
    "end": 58,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 58,
    "end": 61,
    "string": "AND",
    "type": "keyword",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 61,
    "end": 62,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true}
    }
  }, {
    "start": 62,
    "end": 63,
    "string": "(",
    "type": "bracket",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 63,
    "end": 80,
    "string": "common_server_asn",
    "type": "string-2",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 80,
    "end": 81,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 81,
    "end": 82,
    "string": ">",
    "type": "operator",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 82,
    "end": 83,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 83,
    "end": 85,
    "string": "23",
    "type": "number",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 85,
    "end": 86,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 86,
    "end": 88,
    "string": "or",
    "type": "keyword",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 88,
    "end": 89,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 89,
    "end": 102,
    "string": "common_log_id",
    "type": "string-2",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 102,
    "end": 103,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 103,
    "end": 104,
    "string": "=",
    "type": "operator",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 104,
    "end": 105,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 105,
    "end": 107,
    "string": "12",
    "type": "number",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {
        "prev": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
        "indent": 1,
        "col": 62,
        "type": ")",
        "align": true
      }
    }
  }, {
    "start": 107,
    "end": 108,
    "string": ")",
    "type": "bracket",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 1, "type": ")", "align": true},
      "indent": 1
    }
  }, {
    "start": 108,
    "end": 109,
    "string": ")",
    "type": "bracket",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": null,
      "indent": 1
    }
  }, {
    "start": 109,
    "end": 111,
    "string": "  ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": null,
      "indent": 1
    }
  }, {
    "start": 111,
    "end": 114,
    "string": "AND",
    "type": "keyword",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": null,
      "indent": 1
    }
  }, {
    "start": 114,
    "end": 115,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": null,
      "indent": 1
    }
  }, {
    "start": 115,
    "end": 135,
    "string": "common_subscriber_id",
    "type": "string-2",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": null,
      "indent": 1
    }
  }, {
    "start": 135,
    "end": 136,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": null,
      "indent": 1
    }
  }, {
    "start": 136,
    "end": 138,
    "string": "in",
    "type": "builtin",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": null,
      "indent": 1
    }
  }, {
    "start": 138,
    "end": 139,
    "string": " ",
    "type": null,
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": null,
      "indent": 1
    }
  }, {
    "start": 139,
    "end": 140,
    "string": "(",
    "type": "bracket",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 139, "type": ")", "align": true},
      "indent": 1
    }
  }, {
    "start": 140,
    "end": 142,
    "string": "12",
    "type": "number",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 139, "type": ")", "align": true},
      "indent": 1
    }
  }, {
    "start": 142,
    "end": 143,
    "string": ",",
    "type": "punctuation",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 139, "type": ")", "align": true},
      "indent": 1
    }
  }, {
    "start": 143,
    "end": 145,
    "string": "12",
    "type": "number",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 139, "type": ")", "align": true},
      "indent": 1
    }
  }, {
    "start": 145,
    "end": 146,
    "string": ",",
    "type": "punctuation",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 139, "type": ")", "align": true},
      "indent": 1
    }
  }, {
    "start": 146,
    "end": 148,
    "string": "14",
    "type": "number",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": {"prev": null, "indent": 1, "col": 139, "type": ")", "align": true},
      "indent": 1
    }
  }, {
    "start": 148,
    "end": 149,
    "string": ")",
    "type": "bracket",
    "state": {
      "tokenize": {"_custom": {"type": "function", "display": "<span>ƒ</span> tokenBase(stream, state)"}},
      "context": null,
      "indent": 1
    }
  }
]
class Grouping {
  constructor(tokens) {
    //记得在这里  做一下  深拷贝
    this.initClass(tokens)
  }

  initClass(tokens) {
    //记得做一下 深拷贝 备份一下
    //去除空白字符之后的列表
    var enableList=this.filterEmpty(tokens) || []
    //括号筛选
    var bracketObj=this.analysisBracket(enableList)
    var formatedlist=bracketObj.list || []
    var bracketsList=bracketObj.bracketsList || []
    //执行分组
    var groups=this.handleGrouping(formatedlist) || []


    //赋值 记录中间数据
    this.sourceList = tokens
    this.enableList=enableList
    this.formatedlist=formatedlist
    this.groups=groups
    this.bracketsList=bracketsList
  }

  refreshClass(tokens) {

  }

  filterEmpty(list) {
    //过滤掉空字符串
    var reg = /^[ ]+$/
    var result = []
    result = list.filter((item) => {
      return !reg.test(item.string)
    })
    return result
  }

  analysisBracket(list) {
    //重新分析 括号 的问题
    var bracketsList = [] //只留下括号的
    var enableList = list || []   //不存在空字符串的
    bracketsList = list.filter((item, index) => {
      if (item.type === 'bracket') {
        item.enableIndex = index
        return true
      }
      return false
    })
    //遍历括号 列表
    var item = null
    var nextBbracket = null
    var lastToken = null
    for (var i = 0; i < bracketsList.length; i++) {
      item = bracketsList[i];
      if (item.subType) {
        continue
      }
      if (item.string === '(' && item.enableIndex > 0) {
        lastToken = enableList[item.enableIndex - 1]
        //上一个数据是 in  empty
        if (lastToken.type === 'builtin' && ['in', 'empty'].includes(lastToken.string)) {
          item.subType = "expression_bracket"
          item.part = "left"
          nextBbracket = bracketsList[i + 1]
          if (nextBbracket && nextBbracket.string === ')') {
            nextBbracket.subType = "expression_bracket"
            nextBbracket.part = "right"
          }
        } else {
          item.subType = "logic_bracket"
        }
      } else {
        item.subType = "logic_bracket"
      }
    }
    return {
      list,         //去除括号之后的list
      bracketsList  //括号list
    }
  }

  handleGrouping(list) {
    //groupType
    //三种类型  逻辑括号(logicBrackets) 表达式(expression) 和  and/or(gulter)
    var result = [];
    var pointer = 0;
    var item = {};
    for (var i = 0; i < list.length; i++) {
      item = list[i]
      if (i === 0) {
        result[pointer] = {}
        result[pointer].expressionFactors = []
        result[pointer].expressionFactors.push(list[i])
        if (item.type === 'bracket' && item.subType === 'logic_bracket') {
          //是括号 第一个一定是逻辑括号
          result[pointer].groupType = "bracket"
        } else if (item.type === 'keyword') {
          //是关键字  这里关键字 只指的是 and   or
          result[pointer].groupType = "keyword"
        } else {
          //否则 就是属于表达式的一部分
          result[pointer].groupType = "expression"
        }
      }
      if (i > 0) {
        if (item.type === 'bracket' && item.subType === 'logic_bracket') {
          //是一个 逻辑括号
          pointer++;
          result[pointer] = {
            groupType: "bracket",
            expressionFactors: [list[i]]
          }
        } else if (item.type === 'keyword') {
          //是关键字  这里关键字 只指的是 and   or
          pointer++;
          result[pointer] = {
            groupType: "keyword",
            expressionFactors: [list[i]]
          }
        } else {
          //否则 就是属于表达式的一部分
          if (result[pointer].groupType === 'expression') {
            result[pointer].expressionFactors.push(list[i])
          } else {
            pointer++;
            result[pointer] = {
              groupType: "expression",
              expressionFactors: [list[i]]
            }
          }
        }
      }
    }

    return result
  };

  validStr(list){
    !list ? list=this.groups : ''
    var arr = []
    list.forEach((item) => {
      var str = ''
      item.expressionFactors.forEach((ele) => {
        str += ele.string + " "
      });
      arr.push(str)
    })
    return arr
  }
}
var instance1=new Grouping(sourceList)
console.log(instance1.groups)
console.log(instance1.validStr())


